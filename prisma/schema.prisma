// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id             Int        @id @default(autoincrement())
  name           String
  email          String?    @unique
  phone          String?
  address        String?
  rfc            String?
  curp           String?
  isActive       Boolean   @default(true)

  // Configuración de Crédito
  hasCredit      Boolean   @default(false)
  creditLimit    Decimal   @db.Decimal(12, 2) @default(0)
  currentDebt    Decimal   @db.Decimal(12, 2) @default(0) // Campo calculado/caché para velocidad

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  sales                 Sale []
  productPrice          ClientProductPrice[]
  productPriceHistory   ClientProductPriceHistory[]

  @@index([name])
  @@index([rfc])
  @@index([phone])
  @@index([email])
}

model Product {
  id             Int                @id @default(autoincrement())

  name           String
  description    String?
  sku            String             @unique                // Código interno
  barcode        String?            @unique
  controlled     Boolean            @default(false)        // Medicamento controlado
  stock          Int @default(0)
  minStock       Int @default(5)
  price          Decimal            @db.Decimal(10, 2)     // Precio de VENTA al público
  cost           Decimal            @db.Decimal(10, 2)     // Costo promedio actual

  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relación muchos a muchos con categorías
  categories     ProductCategory[]
  
  saleItems                 SaleItem[]
  priceHistory              ProductPriceHistory[]
  purchaseItems             PurchaseItem[]
  clientPrice               ClientProductPrice[]
  clientPriceHistory        ClientProductPriceHistory[]
  movements                 InventoryMovement[]

  @@index([name])
  @@index([sku])
  @@index([barcode])
}

model ProductPriceHistory {
  id          Int          @id @default(autoincrement())

  product     Product      @relation(fields: [productId], references: [id])
  productId   Int
  changedBy   User?        @relation(fields: [changedById], references: [id])
  changedById Int? 

  price       Decimal      @db.Decimal(10, 2)
  startDate   DateTime     @default(now())
  endDate     DateTime?

  @@index([productId])
  @@index([startDate])
}

model Sale {
  id               Int           @id @default(autoincrement())

  client           Client?       @relation(fields: [clientId], references: [id])
  clientId         Int?
  user             User?         @relation(fields: [userId], references: [id])
  userId           Int?        
  // Relación con Turno de Caja (CRÍTICO para cuadrar cajeros)
  cashShift        CashShift?    @relation(fields: [cashShiftId], references: [id])
  cashShiftId      Int?

  // Estado financiero REAL
  paymentStatus    PaymentStatus @default(PENDING) // PENDING, PARTIAL, PAID

  total            Decimal       @db.Decimal(12, 2)
  subtotal         Decimal       @db.Decimal(12, 2)
  paidAmount       Decimal       @db.Decimal(12, 2) @default(0) // Cuánto han pagado
  balance          Decimal       @db.Decimal(12, 2) @default(0) // Cuánto deben (Deuda)

  // Snapshot de utilidad
  totalCost        Decimal       @db.Decimal(12, 2) @default(0) // Suma del costo de los items al momento de venta
  profit           Decimal       @db.Decimal(12, 2) @default(0) // total - totalCost (Sin impuestos)

  invoiceNumber    String?       @unique   //AAA010101AAA202401000000001  Para CFDI 4.0 en México
  flowStatus       SaleFlowStatus @default(DRAFT)
  status           SaleStatus    @default(PENDING)    
  paymentMethod    PaymentMethod @default(CASH)
  note             String?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  items            SaleItem[]
  payments         SalePayment[]
  saleReturn       SaleReturn[]
  saleRefunds      SaleRefund[]

  @@index([createdAt])
  @@index([invoiceNumber])
  @@index([status])
  @@index([paymentMethod])
}

model SaleItem {
  id            Int         @id @default(autoincrement())

  sale          Sale        @relation(fields: [saleId], references: [id])
  saleId        Int
  product       Product     @relation(fields: [productId], references: [id])
  productId     Int

  quantity      Int
  price         Decimal     @db.Decimal(10, 2) //Precio aplicado
  discount      Decimal     @db.Decimal(10, 2) @default(0)
  subtotal      Decimal     @db.Decimal(10, 2)

  // Guardamos cuánto costaba este producto HOY para calcular ganancia histórica
  costAtSale    Decimal     @db.Decimal(10, 2)

  @@index([saleId])
  @@index([productId])
}

model SalePayment {
  id            Int         @id @default(autoincrement())

  sale          Sale        @relation(fields: [saleId], references: [id])
  saleId        Int

  method        PaymentMethod
  amount        Decimal     @db.Decimal(12,2)
  references    String?

  // Si es en efectivo, ¿a qué caja entró?
  cashShiftId   Int?
  isDeposit     Boolean     @default(true) // true = Pago, false = Reembolso

  createdAt     DateTime    @default(now())

  @@index([saleId])
  @@index([method])
}

model SaleReturn { 
  id             Int         @id @default(autoincrement())
  
  sale           Sale        @relation(fields: [saleId], references: [id])
  saleId         Int
  processedBy    User?       @relation(fields: [processedById], references: [id])
  processedById  Int?

  note           String?

  createdAt      DateTime   @default(now())

  items          SaleReturnItem[]
  refund         SaleRefund[]
}

model SaleReturnItem {
  id            Int        @id @default(autoincrement())

  saleReturn    SaleReturn @relation(fields: [saleReturnId], references: [id])
  saleReturnId  Int

  saleItemId    Int
  productId     Int
  quantity      Int
  unitPrice     Decimal   @db.Decimal(10, 2)
  subtotal      Decimal   @db.Decimal(12, 2)
  reason        String?
}

model SaleRefund {
  id           Int        @id @default(autoincrement())

  saleReturn   SaleReturn @relation(fields: [saleReturnId], references: [id])
  saleReturnId Int        @unique
  sale         Sale       @relation(fields: [saleId], references: [id])
  saleId       Int

  amount       Decimal    @db.Decimal(12,2)
  method       PaymentMethod?
  reference    String?

  createdAt    DateTime  @default(now())
}

//TODO: Registrar el vuelto en un futuro: CashMovement, CashMovementType, CashMovementCategory 

model Category {
  id           Int         @id @default(autoincrement())
  name         String
  description  String?
  isActive     Boolean     @default(true)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relación muchos a muchos con productos
  products     ProductCategory[]

  @@unique([name])
  @@index([isActive])
}

// Tabla intermediaria para la relación muchos a muchos entre Product y Category
model ProductCategory {
  id          Int      @id @default(autoincrement())
  
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   Int
  
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId  Int
  
  // Campos adicionales opcionales
  isPrimary   Boolean  @default(false)  // Categoría principal del producto
  order       Int?                      // Orden de importancia de la categoría
  
  createdAt   DateTime @default(now())
  
  @@unique([productId, categoryId])  // Evita duplicados
  @@index([productId])
  @@index([categoryId])
  @@index([isPrimary])
}

model User {
  id          Int          @id @default(autoincrement())

  userName    String       @unique
  password    String
  email       String       @unique
  firstName   String
  lastName    String
  role        UserRole
  isActive    Boolean      @default(true)

  sale                      Sale[]
  productPriceHistory       ProductPriceHistory[]
  clientProductPriceHistory ClientProductPriceHistory[]
  token                     UserToken[]
  saleReturn                SaleReturn[]
  cashData                  CashShift[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userName])
  @@index([email])
}

model Supplier {
  id         Int          @id @default(autoincrement())
  name       String
  contact    String?
  phone      String?
  email      String?      @unique
  isActive   Boolean      @default(true)

  purchases  Purchase[]

  createdAt  DateTime     @default(now())

  @@index([name])
}

model Purchase {
  id            Int             @id @default(autoincrement())

  supplier      Supplier        @relation(fields: [supplierId], references: [id])
  supplierId    Int

  invoiceNumber String
  total         Decimal         @db.Decimal(10, 2)
  subtotal      Decimal         @db.Decimal(10, 2)
  status        PurchaseStatus  @default(PENDING)

  items         PurchaseItem[]
  payments      PurchasePayment[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([status])
}

model PurchaseItem {
  id          Int         @id @default(autoincrement())

  purchase    Purchase    @relation(fields: [purchaseId], references: [id])
  purchaseId  Int
  product     Product     @relation(fields: [productId], references: [id])
  productId   Int

  quantity    Int
  cost        Decimal     @db.Decimal(10, 2)  // Precio de COMPRA real de este lote
  subtotal    Decimal     @db.Decimal(12, 2)
}

model PurchasePayment {
  id          Int         @id @default(autoincrement())

  purchase    Purchase    @relation(fields: [purchaseId], references: [id])
  purchaseId  Int

  method      PaymentMethod
  amount      Decimal     @db.Decimal(10,2)
  references  String?

  createdAt   DateTime    @default(now())

  @@index([purchaseId])
  @@index([method])
}

model ClientProductPrice { //precios especiales por cliente.
  id         Int          @id @default(autoincrement())

  client     Client       @relation(fields: [clientId], references: [id])
  clientId   Int
  product    Product      @relation(fields: [productId], references: [id])
  productId  Int

  price      Decimal      @db.Decimal(10, 2)
  isActive   Boolean      @default(true)

  createdAt  DateTime     @default(now())

  @@unique([clientId, productId])
  @@index([clientId])
  @@index([productId])
}

model ClientProductPriceHistory {
  id          Int           @id @default(autoincrement())

  client      Client        @relation(fields: [clientId], references: [id])
  clientId    Int
  product     Product       @relation(fields: [productId], references: [id])
  productId   Int
  changedBy   User          @relation(fields: [changedById], references: [id])
  changedById Int

  price       Decimal       @db.Decimal(10, 2)

  startDate   DateTime      @default(now())
  endDate     DateTime?
}

model UserToken {
  id            Int       @id @default(autoincrement())

  user          User      @relation(fields: [userId], references: [id])
  userId        Int

  token         String    @unique
  type          TokenType @default(REFRESH)
  ipAddress     String?
  userAgent     String?
  lastUsedAt    DateTime?
  expiresAt     DateTime
  revoked       Boolean   @default(false)
  revokedAt     DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([token])
  @@index([userId])
}

model CashShift {
  id               Int       @id @default(autoincrement())
  
  user             User      @relation(fields: [userId], references: [id])
  userId           Int
  
  // Control de tiempos
  openedAt         DateTime  @default(now())
  closedAt         DateTime? 

  // Control de dinero
  initialAmount    Decimal   @db.Decimal(12, 2) // Fondo de caja inicial
  expectedAmount   Decimal?  @db.Decimal(12, 2) // Calculado por el sistema al cerrar
  realAmount       Decimal?  @db.Decimal(12, 2) // Lo que el cajero contó físicamente (Cierre ciego)
  difference       Decimal?  @db.Decimal(12, 2) // real - expected (Positivo sobra, Negativo falta)

  status           ShiftStatus @default(OPEN)
  
  notes            String?

  transactions     CashTransaction[] // Movimientos de dinero (Entradas/Salidas/Ventas)
  sales            Sale[]            // Ventas ligadas a este turno

  @@index([userId])
  @@index([status])
  @@index([openedAt])
}

model CashTransaction {
  id               Int       @id @default(autoincrement())

  shift            CashShift @relation(fields: [shiftId], references: [id])
  shiftId          Int

  type             CashTransactionType // INGRESO, EGRESO, CORTE
  amount           Decimal   @db.Decimal(12, 2)
  reason           String    // "Retiro por exceso de efectivo", "Pago de luz caja chica"
  
  referenceId      Int?      // ID opcional si viene de una Venta o Compra
  relatedTable     String?   // "Sale", "Purchase"

  createdAt        DateTime  @default(now())
  createdBy        Int       // User ID

  @@index([shiftId])
}

model InventoryMovement {
  id               Int       @id @default(autoincrement())

  product          Product   @relation(fields: [productId], references: [id])
  productId        Int

  type             MovementType
  quantity         Int       // Positivo (Entrada), Negativo (Salida)
  
  // Snapshot financiero: ¿Cuánto valía esto cuando se movió?
  unitCost         Decimal   @db.Decimal(10, 2) 
  totalCost        Decimal   @db.Decimal(12, 2)

  // Trazabilidad
  reason           String    // "Venta #123", "Merma", "Compra #55"
  referenceId      Int?      // ID de Venta, Compra o Ajuste
  
  createdAt        DateTime  @default(now())
  createdBy        Int       // User ID

  @@index([productId])
  @@index([createdAt])
  @@index([type])
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
}

enum MovementType {
  SALE            // Salida por venta
  PURCHASE        // Entrada por compra
  RETURN_IN       // Entrada por devolución de cliente
  RETURN_OUT      // Salida por devolución a proveedor
  ADJUSTMENT      // Ajuste de inventario (Robo, Conteo)
  TRANSFER        // Movimiento entre sucursales (Futuro)
}

enum ShiftStatus {
  OPEN
  CLOSED
  AUDIT_REQUIRED   // Si la diferencia es muy grande, se marca para revisión
}

enum CashTransactionType {
  SALE_INCOME      // Venta Contado
  CREDIT_PAYMENT   // Cliente paga una deuda
  MANUAL_ADD       // Ingreso manual
  MANUAL_WITHDRAW  // Sangría / Retiro
  EXPENSE          // Gasto menor
}


enum TokenType {
  REFRESH          // Para refrescar access tokens
  ACCESS           // Para acceso a recursos (JWT usualmente)
  VERIFICATION     // Para verificar email/cuenta
  PASSWORD_RESET   // Para resetear contraseña
  API              // Tokens de API de larga duración
}

enum UserRole {
  MANAGER 
  ADMIN
  PHARMACIST
  CASHIER
}

enum PaymentMethod {
  CARD
  CASH
  TRANSFER
}

enum SaleStatus {
  PENDING     // Venta registrada pero sin pago
  PARTIAL     // Abonada parcialmente
  COMPLETED   // Pagada completamente
  CANCELLED
  REFUNDED    // Rembolsado
}

enum SaleFlowStatus {
  DRAFT        // Venta abierta, editable
  COMPLETED    // Venta cerrada (stock ya impactado)
  CANCELLED    // Cancelada antes de cerrar
}

enum PurchaseStatus {
  PENDING    // Pedido registrado pero no pagado
  PARTIAL    // Abonado parcialmente
  PAID       // Pagado completamente
  CANCELLED
}